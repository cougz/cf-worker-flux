---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import Sidebar from '../../../components/layout/Sidebar.astro';
import Panel from '../../../components/display/Panel.astro';
import Input from '../../../components/interactive/Input.astro';
import Button from '../../../components/interactive/Button.astro';
import AlertBox from '../../../components/display/AlertBox.astro';
---

<DashboardLayout title="Manage Cache Rule" description="Enable or disable cache rules">
  <div class="module-wrapper">
    <Sidebar />
    <div class="module-content-wrapper">
      <div class="module-content">
        <div class="module-header">
          <h1>Enable/Disable Cache Rule</h1>
          <p>Toggle specific cache rules on or off</p>
        </div>

        <Panel title="Cache Rule Configuration" badge="Manage">
          <div class="cache-config-grid">
            <div class="config-group">
              <Input
                id="zone-id"
                label="Zone ID"
                type="text"
                placeholder="e.g., abc123456789def"
                required
              />
            </div>

            <div class="config-group">
              <Input
                id="ruleset-id"
                label="Ruleset ID"
                type="text"
                placeholder="e.g., def456789012ghi"
                required
              />
            </div>

            <div class="config-group">
              <Input
                id="rule-id"
                label="Rule ID"
                type="text"
                placeholder="e.g., ghi789012345jkl"
                required
              />
            </div>

            <div class="config-group">
              <Input
                id="api-token"
                label="API Token"
                type="password"
                placeholder="Enter your Cloudflare API token"
                required
              />
            </div>
          </div>

          <div class="config-actions">
            <Button
              label="Check Current Status"
              variant="secondary"
              actionName="get-cache-rule-status"
            />
          </div>
        </Panel>

        <div id="cache-rule-status-panel" class="hidden">
          <Panel title="Current Rule Status" badge="Live">
            <div class="status-display">
              <div class="status-row">
                <div class="status-label">Rule ID:</div>
                <div class="status-value" id="status-rule-id">-</div>
              </div>

              <div class="status-row">
                <div class="status-label">Status:</div>
                <div class="status-value" id="status-enabled">-</div>
              </div>

              <div class="status-row">
                <div class="status-label">Description:</div>
                <div class="status-value" id="status-description">-</div>
              </div>

              <div class="status-row">
                <div class="status-label">Last Updated:</div>
                <div class="status-value" id="status-updated">-</div>
              </div>
            </div>

            <div class="status-actions">
              <Button
                label="Enable Rule"
                variant="primary"
                actionName="toggle-cache-rule"
              />
              <Button
                label="Disable Rule"
                variant="danger"
                actionName="toggle-cache-rule"
              />
            </div>
          </Panel>
        </div>

        <AlertBox
          type="info"
          title="Cache Rules"
          message="Manage your Cloudflare cache rules by providing the Zone ID, Ruleset ID, and Rule ID. Your API token is stored in browser session storage and is cleared when you close the tab."
        />
      </div>
    </div>
  </div>
</DashboardLayout>

<style>
  .cache-config-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  @media (min-width: 768px) {
    .cache-config-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .config-group {
    display: flex;
    flex-direction: column;
  }

  .config-actions {
    margin-top: 24px;
  }

  .status-display {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }

  .status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .status-label {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.9em;
  }

  .status-value {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.95em;
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .status-value.enabled {
    color: #10b981;
  }

  .status-value.disabled {
    color: #ef4444;
  }

  .status-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 640px) {
    .status-actions {
      grid-template-columns: 1fr;
    }
  }

  .hidden {
    display: none !important;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let currentStatus = null;

    function loadInputs() {
      const stored = sessionStorage.getItem('cache_rule_inputs');
      if (stored) {
        const inputs = JSON.parse(stored);
        const zoneIdInput = document.getElementById('zone-id') as HTMLInputElement;
        const rulesetIdInput = document.getElementById('ruleset-id') as HTMLInputElement;
        const ruleIdInput = document.getElementById('rule-id') as HTMLInputElement;
        const apiTokenInput = document.getElementById('api-token') as HTMLInputElement;

        if (zoneIdInput) zoneIdInput.value = inputs.zoneId || '';
        if (rulesetIdInput) rulesetIdInput.value = inputs.rulesetId || '';
        if (ruleIdInput) ruleIdInput.value = inputs.ruleId || '';
        if (apiTokenInput) apiTokenInput.value = inputs.apiToken || '';
      }
    }

    function saveInputs() {
      const zoneIdInput = document.getElementById('zone-id') as HTMLInputElement;
      const rulesetIdInput = document.getElementById('ruleset-id') as HTMLInputElement;
      const ruleIdInput = document.getElementById('rule-id') as HTMLInputElement;
      const apiTokenInput = document.getElementById('api-token') as HTMLInputElement;

      if (zoneIdInput && rulesetIdInput && ruleIdInput && apiTokenInput) {
        const inputs = {
          zoneId: zoneIdInput.value,
          rulesetId: rulesetIdInput.value,
          ruleId: ruleIdInput.value,
          apiToken: apiTokenInput.value
        };
        sessionStorage.setItem('cache_rule_inputs', JSON.stringify(inputs));
      }
    }

    function getInputs() {
      const zoneIdInput = document.getElementById('zone-id') as HTMLInputElement;
      const rulesetIdInput = document.getElementById('ruleset-id') as HTMLInputElement;
      const ruleIdInput = document.getElementById('rule-id') as HTMLInputElement;
      const apiTokenInput = document.getElementById('api-token') as HTMLInputElement;

      return {
        zoneId: zoneIdInput?.value || '',
        rulesetIdInput: rulesetIdInput?.value || '',
        ruleIdInput: ruleIdInput?.value || '',
        apiToken: apiTokenInput?.value || ''
      };
    }

    function displayStatus(status: any) {
      const statusPanel = document.getElementById('cache-rule-status-panel');
      const ruleIdEl = document.getElementById('status-rule-id');
      const enabledEl = document.getElementById('status-enabled');
      const descEl = document.getElementById('status-description');
      const updatedEl = document.getElementById('status-updated');

      if (statusPanel) statusPanel.classList.remove('hidden');

      if (ruleIdEl) {
        ruleIdEl.textContent = status.ruleId || '-';
        ruleIdEl.title = status.ruleId;
      }

      if (enabledEl) {
        enabledEl.textContent = status.enabled ? 'Enabled' : 'Disabled';
        enabledEl.className = `status-value ${status.enabled ? 'enabled' : 'disabled'}`;
      }

      if (descEl) {
        descEl.textContent = status.description || '-';
      }

      if (updatedEl) {
        const date = new Date(status.lastUpdated);
        updatedEl.textContent = date.toLocaleString();
      }

      const buttons = document.querySelectorAll('.status-actions button');
      if (status.enabled) {
        buttons[0]?.classList.add('hidden');
        buttons[1]?.classList.remove('hidden');
      } else {
        buttons[0]?.classList.remove('hidden');
        buttons[1]?.classList.add('hidden');
      }
    }

    document.querySelector('button[data-action="get-cache-rule-status"]')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const inputs = getInputs();
      
      if (!inputs.zoneId || !inputs.rulesetIdInput || !inputs.ruleIdInput || !inputs.apiToken) {
        alert('Please fill in all required fields');
        return;
      }

      saveInputs();

      try {
        const response = await fetch('/api/actions/get-cache-rule-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            zoneId: inputs.zoneId,
            rulesetId: inputs.rulesetIdInput,
            ruleId: inputs.ruleIdInput,
            apiToken: inputs.apiToken
          })
        });

        const result = await response.json();
        if (result.success) {
          currentStatus = result.data;
          displayStatus(result.data);
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error: any) {
        alert(`Error checking status: ${error.message}`);
      }
    });

    const toggleButtons = document.querySelectorAll('button[data-action="toggle-cache-rule"]');
    toggleButtons.forEach((button) => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const inputs = getInputs();
        const isEnable = button.textContent?.trim() === 'Enable Rule';

        if (!inputs.zoneId || !inputs.rulesetIdInput || !inputs.ruleIdInput || !inputs.apiToken) {
          alert('Please fill in all required fields');
          return;
        }

        const action = isEnable ? 'enable' : 'disable';
        if (!confirm(`Are you sure you want to ${action} this rule?`)) {
          return;
        }

        try {
          const response = await fetch('/api/actions/toggle-cache-rule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              zoneId: inputs.zoneId,
              rulesetId: inputs.rulesetIdInput,
              ruleId: inputs.ruleIdInput,
              enabled: isEnable,
              apiToken: inputs.apiToken
            })
          });

          const result = await response.json();
          if (result.success) {
            alert(`Rule ${action}d successfully`);
            location.reload();
          } else {
            alert(`Error: ${result.error}`);
          }
        } catch (error: any) {
          alert(`Error ${action}ing rule: ${error.message}`);
        }
      });
    });

    loadInputs();
  });
</script>
