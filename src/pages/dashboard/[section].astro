---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Sidebar from '../../components/layout/Sidebar.astro';
import Panel from '../../components/display/Panel.astro';
import Button from '../../components/interactive/Button.astro';
import Slider from '../../components/interactive/Slider.astro';
import RangeSlider from '../../components/interactive/RangeSlider.astro';
import Input from '../../components/interactive/Input.astro';
import Select from '../../components/interactive/Select.astro';
import Toggle from '../../components/interactive/Toggle.astro';
import ValueDisplay from '../../components/display/ValueDisplay.astro';
import AlertBox from '../../components/display/AlertBox.astro';
import ConfigBlock from '../../components/display/ConfigBlock.astro';

const { section } = Astro.params;

const sectionConfig: Record<string, { title: string; description: string; icon: string }> = {
  'resources': {
    title: 'Resources',
    description: 'Manage and monitor your Cloudflare resources',
    icon: 'üì¶'
  },
  'configuration': {
    title: 'Configuration',
    description: 'Configure worker settings and preferences',
    icon: '‚öôÔ∏è'
  },
  'analytics': {
    title: 'Analytics',
    description: 'View performance metrics and statistics',
    icon: 'üìä'
  },
  'settings': {
    title: 'Settings',
    description: 'Manage dashboard and account settings',
    icon: 'üîß'
  },
  'caching': {
    title: 'Caching',
    description: 'Manage Cloudflare cache rules',
    icon: 'üíæ'
  }
};

const config = section && sectionConfig[section] ? sectionConfig[section] : { title: section || 'Overview', description: '', icon: '‚ö°' };
---

<DashboardLayout title={config.title} description={config.description}>
  <div class="module-wrapper">
    <Sidebar />
    <div class="module-content-wrapper">
      <div id={section} class="module-content">
        <div class="module-header">
          <h1>{config.icon} {config.title}</h1>
          <p>{config.description}</p>
        </div>

        {section === 'resources' && (
          <Panel title="Resource Controls" badge="Active">
            <Toggle id="resource-1" label="Enable Cache" checked />
            <Toggle id="resource-2" label="Enable Rate Limiting" checked />
            <Toggle id="resource-3" label="Enable Analytics" />

            <Slider
              id="cache-ttl"
              label="Cache TTL (minutes)"
              min={1}
              max={1440}
              defaultValue={60}
            />

            <Button
              label="Save Changes"
              actionName="save-resource-state"
              variant="primary"
            />
          </Panel>
        )}

        {section === 'configuration' && (
          <Panel title="Worker Configuration">
            <Input
              id="api-endpoint"
              label="API Endpoint"
              type="text"
              placeholder="https://api.cloudflare.com"
              required
            />

            <Select
              id="region"
              label="Region"
              options={[
                { value: 'us-east', label: 'US East' },
                { value: 'us-west', label: 'US West' },
                { value: 'eu-west', label: 'EU West' },
                { value: 'asia-east', label: 'Asia East' }
              ]}
              defaultValue="us-east"
            />

            <RangeSlider
              id="memory-limits"
              label="Memory Limits (MB)"
              min={128}
              max={1024}
              defaultMin={256}
              defaultMax={512}
              step={64}
            />

            <div class="flex gap-4 mt-4">
              <Button label="Test Connection" actionName="test-api-connection" variant="secondary" />
              <Button label="Save Configuration" actionName="update-config" variant="primary" />
            </div>
          </Panel>
        )}

        {section === 'analytics' && (
          <>
            <Panel title="Performance Metrics" badge="Live">
              <div class="analytics-grid">
                <ValueDisplay
                  label="Total Requests"
                  value="142,853"
                  format="number"
                  status="success"
                />
                <ValueDisplay
                  label="Error Rate"
                  value="0.12%"
                  format="text"
                  status="success"
                />
                <ValueDisplay
                  label="Avg Latency"
                  value="45ms"
                  format="text"
                  status="info"
                />
                <ValueDisplay
                  label="Cache Hit Rate"
                  value="94.2%"
                  format="text"
                  status="success"
                />
              </div>

              <Button
                label="Refresh Analytics"
                actionName="get-analytics"
                variant="secondary"
              />
            </Panel>

            <Panel title="Time Range Filter">
              <Slider
                id="time-range"
                label="Time Range (hours)"
                min={1}
                max={168}
                defaultValue={24}
              />
            </Panel>

            <AlertBox
              type="info"
              title="Analytics Note"
              message="Analytics data is updated every 5 minutes. Last update: 2 minutes ago."
            />
          </>
        )}

        {section === 'settings' && (
          <>
            <Panel title="Dashboard Settings">
              <Toggle id="dark-mode" label="Dark Mode" />
              <Toggle id="notifications" label="Enable Notifications" checked />
              <Toggle id="auto-refresh" label="Auto Refresh" />

              <Input
                id="refresh-interval"
                label="Refresh Interval (seconds)"
                type="number"
                placeholder="30"
                defaultValue="30"
              />

              <Button label="Save Settings" actionName="update-config" variant="primary" />
            </Panel>

            <Panel title="Account Settings" collapsible>
              <Input
                id="account-name"
                label="Account Name"
                type="text"
                placeholder="My Account"
              />

              <Input
                id="api-key"
                label="API Key"
                type="password"
                placeholder="Enter your API key"
                required
              />

              <Button label="Update Account" actionName="update-config" variant="secondary" />
            </Panel>
          </>
        )}

        {section === 'caching' && (
          <>
            <Panel title="Cache Rule Configuration">
              <div class="cache-rule-form">
                <Input
                  id="zone-id"
                  label="Zone ID"
                  type="text"
                  placeholder="e.g., abc123456789def"
                  required
                />

                <Input
                  id="ruleset-id"
                  label="Ruleset ID"
                  type="text"
                  placeholder="e.g., def456789012ghi"
                  required
                />

                <Input
                  id="rule-id"
                  label="Rule ID"
                  type="text"
                  placeholder="e.g., ghi789012345jkl"
                  required
                />

                <Input
                  id="api-token"
                  label="API Token"
                  type="password"
                  placeholder="Enter your Cloudflare API token"
                  required
                />

                <div class="flex gap-4 mt-4">
                  <button
                    id="check-status-btn"
                    class="button button-secondary"
                  >
                    Check Current Status
                  </button>
                </div>
              </div>
            </Panel>

            <div id="cache-rule-status-panel" class="hidden">
              <Panel title="Current Rule Status" badge="Live">
                <div class="status-display">
                  <div class="status-item">
                    <span class="status-label">Rule ID:</span>
                    <span class="status-value" id="status-rule-id">-</span>
                  </div>

                  <div class="status-item">
                    <span class="status-label">Status:</span>
                    <span class="status-value" id="status-enabled">-</span>
                  </div>

                  <div class="status-item">
                    <span class="status-label">Description:</span>
                    <span class="status-value" id="status-description">-</span>
                  </div>

                  <div class="status-item">
                    <span class="status-label">Last Updated:</span>
                    <span class="status-value" id="status-updated">-</span>
                  </div>
                </div>

                <div class="flex gap-4 mt-4">
                  <button
                    id="enable-rule-btn"
                    class="button button-success"
                    style="display: none;"
                  >
                    Enable Rule
                  </button>
                  <button
                    id="disable-rule-btn"
                    class="button button-danger"
                    style="display: none;"
                  >
                    Disable Rule
                  </button>
                </div>
              </Panel>
            </div>

            <AlertBox
              type="info"
              title="Cache Rules"
              message="Manage your Cloudflare cache rules by providing the Zone ID, Ruleset ID, and Rule ID. Your API token is stored in browser session storage and is cleared when you close the tab."
            />
          </>
        )}
      </div>
    </div>
  </div>
</DashboardLayout>

<style>
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .cache-rule-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .status-display {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }

  .status-label {
    font-weight: 600;
    color: var(--text-secondary);
  }

  .status-value {
    font-weight: 500;
    color: var(--text-primary);
  }

  .status-value.enabled {
    color: #10b981;
  }

  .status-value.disabled {
    color: #ef4444;
  }

  .hidden {
    display: none !important;
  }

  @media (max-width: 768px) {
    .analytics-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  </style>

{section === 'caching' && (
  <script>
    import stateManager from '../../scripts/state-manager';

    let currentStatus: any = null;

    function loadInputs() {
      const stored = sessionStorage.getItem('cache_rule_inputs');
      if (stored) {
        const inputs = JSON.parse(stored);
        const zoneIdInput = document.getElementById('zone-id') as HTMLInputElement;
        const rulesetIdInput = document.getElementById('ruleset-id') as HTMLInputElement;
        const ruleIdInput = document.getElementById('rule-id') as HTMLInputElement;
        const apiTokenInput = document.getElementById('api-token') as HTMLInputElement;

        if (zoneIdInput) zoneIdInput.value = inputs.zoneId || '';
        if (rulesetIdInput) rulesetIdInput.value = inputs.rulesetId || '';
        if (ruleIdInput) ruleIdInput.value = inputs.ruleId || '';
        if (apiTokenInput) apiTokenInput.value = inputs.apiToken || '';
      }
    }

    function saveInputs() {
      const zoneIdInput = document.getElementById('zone-id') as HTMLInputElement;
      const rulesetIdInput = document.getElementById('ruleset-id') as HTMLInputElement;
      const ruleIdInput = document.getElementById('rule-id') as HTMLInputElement;
      const apiTokenInput = document.getElementById('api-token') as HTMLInputElement;

      if (zoneIdInput && rulesetIdInput && ruleIdInput && apiTokenInput) {
        const inputs = {
          zoneId: zoneIdInput.value,
          rulesetId: rulesetIdInput.value,
          ruleId: ruleIdInput.value,
          apiToken: apiTokenInput.value
        };
        sessionStorage.setItem('cache_rule_inputs', JSON.stringify(inputs));
      }
    }

    function getInputs() {
      const zoneIdInput = document.getElementById('zone-id') as HTMLInputElement;
      const rulesetIdInput = document.getElementById('ruleset-id') as HTMLInputElement;
      const ruleIdInput = document.getElementById('rule-id') as HTMLInputElement;
      const apiTokenInput = document.getElementById('api-token') as HTMLInputElement;

      return {
        zoneId: zoneIdInput?.value || '',
        rulesetId: rulesetIdInput?.value || '',
        ruleId: ruleIdInput?.value || '',
        apiToken: apiTokenInput?.value || ''
      };
    }

    async function checkStatus() {
      const inputs = getInputs();
      if (!inputs.zoneId || !inputs.rulesetId || !inputs.ruleId || !inputs.apiToken) {
        alert('Please fill in all required fields');
        return;
      }

      saveInputs();

      try {
        const result = await stateManager.executeAction('get-cache-rule-status', inputs);
        currentStatus = result;
        displayStatus(result);
      } catch (error: any) {
        alert(`Error checking status: ${error.message}`);
      }
    }

    function displayStatus(status: any) {
      const statusPanel = document.getElementById('cache-rule-status-panel');
      const ruleIdEl = document.getElementById('status-rule-id');
      const enabledEl = document.getElementById('status-enabled');
      const descEl = document.getElementById('status-description');
      const updatedEl = document.getElementById('status-updated');
      const enableBtn = document.getElementById('enable-rule-btn') as HTMLButtonElement;
      const disableBtn = document.getElementById('disable-rule-btn') as HTMLButtonElement;

      if (statusPanel) statusPanel.classList.remove('hidden');

      if (ruleIdEl) {
        ruleIdEl.textContent = status.ruleId || '-';
        ruleIdEl.title = status.ruleId;
      }

      if (enabledEl) {
        enabledEl.textContent = status.enabled ? 'Enabled' : 'Disabled';
        enabledEl.className = `status-value ${status.enabled ? 'enabled' : 'disabled'}`;
      }

      if (descEl) {
        descEl.textContent = status.description || '-';
      }

      if (updatedEl) {
        const date = new Date(status.lastUpdated);
        updatedEl.textContent = date.toLocaleString();
      }

      if (enableBtn && disableBtn) {
        if (status.enabled) {
          enableBtn.style.display = 'none';
          disableBtn.style.display = 'inline-block';
        } else {
          enableBtn.style.display = 'inline-block';
          disableBtn.style.display = 'none';
        }
      }
    }

    async function toggleRule(enable: boolean) {
      const inputs = getInputs();
      if (!inputs.zoneId || !inputs.rulesetId || !inputs.ruleId || !inputs.apiToken) {
        alert('Please fill in all required fields');
        return;
      }

      const action = enable ? 'enable' : 'disable';
      if (!confirm(`Are you sure you want to ${action} this rule?`)) {
        return;
      }

      try {
        await stateManager.executeAction('toggle-cache-rule', { ...inputs, enabled: enable });
        await checkStatus();
        alert(`Rule ${action}d successfully`);
      } catch (error: any) {
        alert(`Error ${action}ing rule: ${error.message}`);
      }
    }

    function setupEventListeners() {
      const checkBtn = document.getElementById('check-status-btn');
      const enableBtn = document.getElementById('enable-rule-btn');
      const disableBtn = document.getElementById('disable-rule-btn');

      if (checkBtn) {
        checkBtn.addEventListener('click', checkStatus);
      }

      if (enableBtn) {
        enableBtn.addEventListener('click', () => toggleRule(true));
      }

      if (disableBtn) {
        disableBtn.addEventListener('click', () => toggleRule(false));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadInputs();
      setupEventListeners();
    });
  </script>
)}
