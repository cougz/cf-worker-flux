---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Sidebar from '../../components/layout/Sidebar.astro';

const transformationPresets = [
  { id: 'resize', label: 'Resize 800×600' },
  { id: 'webp', label: 'Format to WebP' },
  { id: 'avif', label: 'Format to AVIF' },
  { id: 'border', label: 'Add Orange Border' },
  { id: 'grayscale', label: 'Convert to Grayscale' },
  { id: 'brightness', label: 'Brighten +50%' },
];
---

  <DashboardLayout title="Cloudflare Images Demo" description="Transform images using Cloudflare CDN">
  <div class="module-wrapper">
    <Sidebar />
    <div class="module-content-wrapper">
      <div class="images-demo">
          <div class="panel-section">
            <div class="header-content">
              <h1>Cloudflare Images Demo</h1>
              <p>Transform images using Cloudflare CDN-powered transformations</p>
              <a href="https://developers.cloudflare.com/images/transform-images/transform-via-url/" target="_blank" rel="noopener" class="docs-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 4v16c0 1-1 1h14c-1 0-2-2-2h14c0 1 1v16z"></path>
                <polyline points="9 18 15 13 18"></polyline>
                <path d="M5 19a1 1 1v6a2 2 0 12-2h3a2 2 0 12-2v-6z"></path>
              </svg>
                Documentation
              </a>
            </div>
          </div>

        <div class="images-layout">
          <div class="images-left-panel">
            <div class="panel-section">
              <h2>Original Image</h2>
              <div class="image-preview original-image">
                <img src="/source.jpg" alt="Original Image" id="original-image" />
                <div class="image-info">
                  <span class="image-label">File:</span>
                  <span class="image-value">source.jpg</span>
                  <span class="image-label">Dimensions:</span>
                  <span class="image-value">1920×1080</span>
                </div>
              </div>
            </div>

            <div class="panel-section">
              <h2>Transform Options</h2>
              <div class="transform-controls">
                <div class="control-group">
                  <label class="control-label">Quick Presets</label>
                  <div class="preset-buttons">
                  {transformationPresets.map((preset, index) => (
                      <button
                        class={`preset-btn ${index === 0 ? 'active' : ''}`}
                        data-preset={preset.id}
                      >
                        {preset.label}
                      </button>
                    ))}
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label">Custom Options</label>
                  <textarea
                    id="custom-options"
                    class="options-input"
                    placeholder="width=800,height=600,format=webp..."
                  ></textarea>
                  <div class="options-hint">
                    Available options: width, height, format, quality, border, blur, brightness, contrast, fit, gravity, rotate, saturation, gamma, metadata, compression, dpr, sharpen
                  </div>
                </div>

                <div class="control-group">
                  <label class="control-label">Preview URL</label>
                  <div class="url-display">
                    <code id="transformed-url">/cdn-cgi/image/width=800,height=600/source.jpg</code>
                    <button id="copy-url" class="copy-btn">Copy</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="images-right-panel">
            <div class="panel-section">
              <h2>Transformed Preview</h2>
              <div class="image-preview transformed-image">
                <img src="/cdn-cgi/image/width=800,height=600/source.jpg" alt="Transformed Image" id="transformed-image" />
              </div>
            </div>

            <div class="panel-section">
              <h2>CDN URI</h2>
              <div class="code-block">
                <pre><code id="transformed-url-display">https://your-domain.com/cdn-cgi/image/width=800,height=600/source.jpg</code></pre>
                <button id="copy-uri" class="copy-btn">Copy URI</button>
              </div>
            </div>

            <div class="panel-section">
              <h2>HTML Markup</h2>
              <div class="code-block">
                <pre><code id="html-code">&lt;img src="/cdn-cgi/image/width=800,height=600/source.jpg" alt="Transformed Image" /&gt;</code></pre>
                <button id="copy-html" class="copy-btn">Copy HTML</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </DashboardLayout>

<style>
  .images-demo {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .header-content h1 {
    margin: 0 0 8px 0;
    font-size: 1.5em;
    color: var(--text-primary);
  }

  .header-content p {
    margin: 0 0 16px 0;
    color: var(--text-secondary);
    font-size: 0.95em;
  }

  .docs-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    background: var(--cf-orange);
    color: white;
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    font-size: 0.9em;
    transition: all var(--transition-fast);
  }

  .docs-link:hover {
    background: var(--cf-orange-dark);
    transform: translateY(-2px);
  }

  .images-layout {
    display: flex;
    gap: 24px;
    flex: 1;
  }

  .images-left-panel {
    flex: 0 0 auto;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .images-right-panel {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .panel-section {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 24px;
  }

  .panel-section h2 {
    margin: 0 0 16px 0;
    font-size: 1.25em;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-light);
    padding-bottom: 12px;
  }

  .image-preview {
    width: 100%;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
  }

  .image-preview img {
    max-width: 100%;
    max-height: 300px;
    object-fit: contain;
  }

  .original-image img {
    max-height: 400px;
  }

  .transformed-image img {
    max-height: 400px;
  }

  .image-info {
    margin-top: 16px;
    padding: 12px;
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px 12px;
    font-size: 0.9em;
    align-items: center;
  }

  .image-label {
    color: var(--text-secondary);
    font-weight: 500;
  }

  .image-value {
    color: var(--text-primary);
    font-weight: 600;
  }

  .transform-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-label {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--text-primary);
  }

  .preset-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }

  .preset-btn {
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9em;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: inherit;
  }

  .preset-btn:hover {
    border-color: var(--cf-orange);
    background: var(--bg-primary);
  }

  .preset-btn.active {
    background: var(--cf-orange);
    color: white;
    border-color: var(--cf-orange);
  }

  .options-input {
    width: 100%;
    min-height: 100px;
    padding: 12px;
    background: var(--bg-primary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.85em;
    resize: vertical;
  }

  .options-hint {
    font-size: 0.8em;
    color: var(--text-muted);
    margin-top: 4px;
    line-height: 1.4;
  }

  .url-display {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .url-display code {
    flex: 1;
    padding: 10px 12px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.8em;
    color: var(--text-primary);
    overflow-x: auto;
    white-space: pre;
    word-break: break-all;
  }

  .copy-btn {
    padding: 8px 16px;
    background: var(--cf-orange);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 500;
    transition: all var(--transition-fast);
    font-family: inherit;
  }

  .copy-btn:hover {
    background: var(--cf-orange-dark);
    transform: translateY(-2px);
  }

  .code-block {
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 16px;
    position: relative;
  }

  .code-block pre {
    margin: 0;
    overflow-x: auto;
  }

  .code-block code {
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.8em;
    color: var(--text-primary);
  }

  .code-block .copy-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 6px 12px;
  }

  .size-comparison {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: linear-gradient(135deg, var(--cf-orange) 0%, var(--cf-orange-light) 100%);
    border-radius: var(--radius-md);
  }

  .size-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .size-label {
    font-size: 0.85em;
    color: white;
    opacity: 0.9;
  }

  .size-value {
    font-size: 1.2em;
    font-weight: 700;
    color: white;
  }

  .size-value.large {
    color: #ff9999;
  }

  .size-value.small {
    color: #4ade80;
  }

  .size-arrow {
    font-size: 2em;
    color: rgba(255, 255, 255, 0.5);
  }

  @media (max-width: 1024px) {
    .images-layout {
      flex-direction: column;
    }

    .images-left-panel {
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .panel-section {
      padding: 16px;
    }

    .image-preview {
      min-height: 200px;
    }

    .image-preview img,
    .original-image img,
    .transformed-image img {
      max-height: 250px;
    }

    .image-info {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .preset-buttons {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // State
  let selectedPreset = 'width=800,height=600';

  // DOM Elements
  const presetButtons = document.querySelectorAll('[data-preset]');
  const customOptionsInput = document.getElementById('custom-options') as HTMLTextAreaElement;
  const transformedUrlDisplay = document.getElementById('transformed-url-display') as HTMLElement;
  const transformedImage = document.getElementById('transformed-image') as HTMLImageElement;
  const htmlCode = document.getElementById('html-code') as HTMLElement;
  const copyUrlBtns = document.querySelectorAll('.copy-btn') as NodeListOf<HTMLButtonElement>;
  const copyUrlBtn = copyUrlBtns[0];
  const copyUriBtn = copyUrlBtns[1];
  const copyHtmlBtn = copyUrlBtns[2];

  // Preset options mapping
  const presetOptions: Record<string, string> = {
    'resize': 'width=800,height=600',
    'webp': 'format=webp,quality=80',
    'avif': 'format=avif,quality=85',
    'border': 'border=10,%23F48024',
    'grayscale': 'saturation=0',
    'brightness': 'brightness=1.5',
  };

  // Build transformation URL
  function buildTransformUrl(options: string): string {
    return `/cdn-cgi/image/${options}/source.jpg`;
  }

  // Update preview and code
  function updatePreview() {
    const path = buildTransformUrl(selectedPreset);
    transformedUrlDisplay.textContent = path;
    transformedImage.src = path;
    htmlCode.textContent = `<img src="${path}" alt="Transformed Image" />`;
  }

  // Handle preset selection
  presetButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const presetId = btn.getAttribute('data-preset');
      if (presetId && presetOptions[presetId]) {
        selectedPreset = presetOptions[presetId];
        customOptionsInput.value = '';
        // Update active state on buttons
        presetButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updatePreview();
      }
    });
  });

  // Handle custom options - listen for both input and change events
  const handleCustomOptions = () => {
    const customValue = customOptionsInput.value.trim();
    if (customValue) {
      selectedPreset = customValue;
      // Remove active state from preset buttons when using custom
      presetButtons.forEach(b => b.classList.remove('active'));
      updatePreview();
    }
  };
  
  customOptionsInput.addEventListener('input', handleCustomOptions);
  customOptionsInput.addEventListener('change', handleCustomOptions);

  // Copy URL
  copyUrlBtn.addEventListener('click', async () => {
    const url = (document.getElementById('transformed-url') as HTMLElement).textContent || '';
    if (url) {
      await navigator.clipboard.writeText(url);
      copyUrlBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyUrlBtn.textContent = 'Copy';
      }, 2000);
    }
  });

  // Copy URI
  copyUriBtn.addEventListener('click', async () => {
    const url = transformedUrlDisplay.textContent || '';
    if (url) {
      await navigator.clipboard.writeText(url);
      copyUriBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyUriBtn.textContent = 'Copy URI';
      }, 2000);
    }
  });

  // Copy HTML
  copyHtmlBtn.addEventListener('click', async () => {
    const code = htmlCode.textContent || '';
    if (code) {
      await navigator.clipboard.writeText(code);
      copyHtmlBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyHtmlBtn.textContent = 'Copy HTML';
      }, 2000);
    }
  });

  // Initial load
  updatePreview();
</script>
