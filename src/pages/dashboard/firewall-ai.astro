---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Sidebar from '../../components/layout/Sidebar.astro';

const testPrompts = [
  {
    category: 'Nationality Detection',
    prompts: [
      { label: 'Test Nationality PII', prompt: 'My boss is from Germany and his wife is from France, can you help me with their files?' },
    ]
  }
];
---

<DashboardLayout title="Firewall for AI Demo" description="Chat with the Macrodata Refinement Assistant">
  <div class="module-wrapper">
    <Sidebar />
    <div class="module-content-wrapper">
      <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="chat-header-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
            </div>
            <div class="chat-header-text">
              <h1>Firewall for AI Demo</h1>
              <p>Macrodata Refinement Assistant</p>
            </div>
          </div>
          <button id="clear-chat" class="clear-chat-button" aria-label="Clear chat history">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            Clear
          </button>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" id="chat-messages">
          <!-- Messages will be inserted here -->
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <span>Assistant is typing...</span>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
          <div class="chat-input-wrapper">
            <textarea
              id="chat-input"
              class="chat-input"
              placeholder="Type your message..."
              rows="1"
            ></textarea>
            <button id="send-button" class="send-button" aria-label="Send message">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
          <div class="test-prompts-section">
            <div class="test-prompts-header">
              <span class="test-prompts-title">Quick Test</span>
              <span class="test-prompts-subtitle">Click to pre-fill</span>
            </div>
            <div class="test-prompts-grid">
              {testPrompts.map((category) => (
                <div class="test-category">
                  <div class="test-category-buttons">
                    {category.prompts.map((item) => (
                      <button
                        class="test-prompt-button"
                        data-prompt={item.prompt}
                      >
                        {item.label}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<style>
  .chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 180px);
    min-height: 500px;
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-subtle);
    overflow: hidden;
  }

  /* Header */
  .chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 20px 24px;
    background: linear-gradient(135deg, var(--cf-orange) 0%, var(--cf-orange-light) 100%);
    color: white;
  }

  .chat-header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .chat-header-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
  }

  .clear-chat-button {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all var(--transition-fast);
  }

  .clear-chat-button:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
  }

  .clear-chat-button:active {
    transform: translateY(0);
  }

  .chat-header-text h1 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .chat-header-text p {
    margin: 4px 0 0 0;
    font-size: 0.875rem;
    opacity: 0.9;
  }

  /* Messages Area */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .chat-messages:empty::after {
    content: 'Start a conversation by typing a message below.';
    color: var(--text-muted);
    text-align: center;
    margin: auto;
    font-size: 0.9rem;
  }

  /* Message Bubbles */
  .message {
    display: flex;
    flex-direction: column;
    max-width: 80%;
    animation: messageSlideIn 0.3s ease;
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message.user {
    align-self: flex-end;
  }

  .message.assistant {
    align-self: flex-start;
  }

  .message-bubble {
    padding: 12px 16px;
    border-radius: var(--radius-lg);
    line-height: 1.5;
    word-wrap: break-word;
  }

  .message.user .message-bubble {
    background: var(--cf-orange);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .message.assistant .message-bubble {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    border-bottom-left-radius: 4px;
  }

  .message.error .message-bubble {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  [data-theme="dark"] .message.error .message-bubble {
    background: #450a0a;
    color: #fecaca;
    border: 1px solid #7f1d1d;
  }

  .message-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 4px;
    padding: 0 4px;
  }

  .message.user .message-label {
    text-align: right;
  }

  /* Typing Indicator */
  .typing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 0 24px 16px 24px;
    color: var(--text-muted);
    font-size: 0.875rem;
  }

  .typing-indicator.visible {
    display: flex;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    background: var(--cf-orange);
    border-radius: 50%;
    animation: typingBounce 1.4s ease-in-out infinite;
  }

  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typingBounce {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    30% {
      transform: translateY(-8px);
      opacity: 1;
    }
  }

  /* Input Area */
  .chat-input-area {
    padding: 16px 24px 24px 24px;
    background: var(--bg-primary);
  }

  .chat-input-wrapper {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .chat-input {
    flex: 1;
    padding: 12px 16px;
    font-family: inherit;
    font-size: 1rem;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-primary);
    color: var(--text-primary);
    resize: none;
    min-height: 48px;
    max-height: 150px;
    line-height: 1.5;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .chat-input:focus {
    outline: none;
    border-color: var(--cf-orange);
    box-shadow: 0 0 0 3px rgba(244, 128, 36, 0.1);
  }

  .chat-input::placeholder {
    color: var(--text-muted);
  }

  .send-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: var(--cf-orange);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    flex-shrink: 0;
  }

  .send-button:hover:not(:disabled) {
    background: var(--cf-orange-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .send-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Test Prompts Section */
  .test-prompts-section {
    margin-top: 12px;
  }

  .test-prompts-header {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 12px;
  }

  .test-prompts-title {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .test-prompts-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .test-prompts-grid {
    display: flex;
    gap: 16px;
  }

  .test-category {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .test-category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .test-prompt-button {
    padding: 8px 16px;
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 500;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .test-prompt-button:hover {
    border-color: var(--cf-orange);
    color: var(--cf-orange);
    background: var(--bg-primary);
    transform: translateY(-1px);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .chat-container {
      height: calc(100vh - 140px);
    }

    .chat-header {
      padding: 16px;
    }

    .chat-messages {
      padding: 16px;
    }

    .chat-input-area {
      padding: 12px 16px 16px 16px;
    }

    .test-prompts-grid {
      grid-template-columns: 1fr;
    }

    .message {
      max-width: 90%;
    }
  }
</style>

<script>
  interface ChatMessage {
    role: 'user' | 'assistant';
    content: string;
  }

  // State
  let conversationHistory: ChatMessage[] = [];
  let isLoading = false;

  // DOM Elements
  const messagesContainer = document.getElementById('chat-messages') as HTMLDivElement;
  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
  const sendButton = document.getElementById('send-button') as HTMLButtonElement;
  const typingIndicator = document.getElementById('typing-indicator') as HTMLDivElement;
  const testPromptButtons = document.querySelectorAll('.test-prompt-button');
  const clearChatButton = document.getElementById('clear-chat') as HTMLButtonElement;

  // Auto-resize textarea
  function autoResize() {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
  }

  chatInput.addEventListener('input', autoResize);

  // Send message on Enter (Shift+Enter for newline)
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Send button click
  sendButton.addEventListener('click', sendMessage);

  // Clear chat button
  clearChatButton.addEventListener('click', () => {
    conversationHistory = [];
    messagesContainer.innerHTML = '';
  });

  // Test prompt buttons
  testPromptButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const prompt = button.getAttribute('data-prompt');
      if (prompt) {
        chatInput.value = prompt;
        autoResize();
        chatInput.focus();
      }
    });
  });

  // Add message to UI
  function addMessage(role: 'user' | 'assistant' | 'error', content: string) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;

    const labelDiv = document.createElement('div');
    labelDiv.className = 'message-label';
    labelDiv.textContent = role === 'user' ? 'You' : role === 'error' ? 'Error' : 'Assistant';

    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.textContent = content;

    messageDiv.appendChild(labelDiv);
    messageDiv.appendChild(bubbleDiv);
    messagesContainer.appendChild(messageDiv);

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Show/hide typing indicator
  function setTyping(visible: boolean) {
    if (visible) {
      typingIndicator.classList.add('visible');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } else {
      typingIndicator.classList.remove('visible');
    }
  }

  // Send message to API
  async function sendMessage() {
    const prompt = chatInput.value.trim();
    if (!prompt || isLoading) return;

    // Clear input
    chatInput.value = '';
    autoResize();

    // Add user message to UI
    addMessage('user', prompt);

    // Add to history
    conversationHistory.push({ role: 'user', content: prompt });

    // Show loading state
    isLoading = true;
    sendButton.disabled = true;
    setTyping(true);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          prompt,
          history: conversationHistory.slice(0, -1), // Exclude current message (already in prompt)
        }),
      });

      let data;
      try {
        data = await response.json();
      } catch (parseError) {
        // JSON parse failed - likely got HTML from firewall
        const errorMessage = 'The work is mysterious and important. Your inquiry contains data that requires refinement.';
        addMessage('error', errorMessage);
        conversationHistory.pop();
        return;
      }

      if (!response.ok || data.error) {
        // Display error as assistant message
        let errorMessage = data.error || `Request failed with status ${response.status}`;
        
        // Enhance firewall blocking errors with theming (short Severance style)
        if (response.status === 403 || 
            errorMessage.includes('security protocols') ||
            errorMessage.includes('refinement') ||
            errorMessage.includes('handbook')) {
          // Keep the themed error message from the backend
          errorMessage = errorMessage; // Use the backend's themed message
        }
        
        addMessage('error', errorMessage);
        // Remove failed user message from history
        conversationHistory.pop();
      } else {
        // Add assistant response to UI and history
        const assistantMessage = data.response;
        addMessage('assistant', assistantMessage);
        conversationHistory.push({ role: 'assistant', content: assistantMessage });
      }
    } catch (error) {
      // Network or parsing error
      const errorMessage = error instanceof Error ? error.message : 'Failed to connect to the server';
      addMessage('error', errorMessage);
      // Remove failed user message from history
      conversationHistory.pop();
    } finally {
      isLoading = false;
      sendButton.disabled = false;
      setTyping(false);
      chatInput.focus();
    }
  }
</script>
